<!doctype html>
<html>
    <head>
        <title>Timgroup: Experiment 1</title>
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
        <script src="./jquery.min.js"></script>
        <script src="./jspsych.js"></script>
        <script src="./plugins/jspsych-instructions.js"></script>
        <script src="./plugins/jspsych-fullscreen.js"></script>
        <script src="./plugins/jspsych-anna.js"></script>
        <script src="./guiInfo.js"></script>
        <script src="./userInfo.js"></script>
        <script src="./imgData.js"></script>
        <script src="./timeline.js"></script>
        <script src="./instructions.js"></script>
        <!-- <script> var ip = "<?php echo $_SERVER['REMOTE_ADDR']; ?>";</script> -->
        <link href="./css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link href="./loadingSmiley.css" rel="stylesheet" type="text/css"></link>
    </head>
    <script>

    var User = {
      urlHasInfo : function(){
        var mandKeys = ['i','c','a','m','ch','r','s'];
        var urlData = jsPsych.data.urlVariables();
        for (var i =0;i<mandKeys.length;i++){
          if (Object.keys(urlData).indexOf(mandKeys[i])<= -1){
            return false
          };
          return true
        };
      },
      getUserInfo : function(){
        var urlData = jsPsych.data.urlVariables();
        var charityMap = {
          1 : 'WWF',
          2 : 'Greenpeace',
          3 : 'Declaration of Bern',
          4 : 'Amnesty International',
          7 : 'Caritas',
          8 : 'Terres des Hommes',
          9 : 'Unicef',
          10 : 'Médecins sans Frontières'
        };
        var userData = {
          UID : urlData.i,
          arrowcode : urlData.a.split('').map(function(i){return parseInt(i)}),
          colorcode : urlData.c.split('').map(function(i){return parseInt(i)}),
          mefirst : parseInt(urlData.m),
          charity : isNaN(urlData.ch) ? urlData.ch : charityMap[parseInt(urlData.ch)] ,
          responseID : urlData.r,
          sessionID : parseInt(urlData.s),
          sessionCode : jsPsych.randomization.randomID(12),
          sessionStart : new Date().toString()
        };
        return userData
      },
      init: function(){
        if (this.urlHasInfo()){
          inf = this.getUserInfo();
          jsPsych.data.addProperties({UID:inf.UID});
          return inf;
        }else{
          var str = '<p>This URL is invalid. Please try to reopen the link from qualtrics again.<br>If the problem still occurs please contact Anna Dereky at adereky(at)ethz.ch.</p>';
          $('body').html(Experiment.timeline.wrap(str,150));
          Experiment.abort();
        };
      }
    };

    var Img = {
      regular : {
        items : imgData.regular,
        shuffled : function(){
          return jsPsych.randomization.shuffle(this.items);
        },
        paths : function(){
          return this.items.map(function(i){
            return i['path'];
          });
        }
      },
      fractals : {
        items : imgData.fractals,
        paths : function(){
          return this.items.map(function(i){
            return i['path'];
          });
        }
      },
      imgPaths : function(){
        return imgPaths =  this.regular.paths().concat(this.fractals.paths());
      },
      loadingSmiley : function(){
        Experiment.backgroundDiv()
        var smileyDivs = '<div id="loadingSmiley" style="margin-top:'+((screen.height*0.5)-100).toString()+'px;"><center><p>Loading</p>\
          <div class="leftEye"></div><div class="rightEye"></div><div class="mouth"></div></center></div>';
        Experiment.displayStr(smileyDivs)
      },
      preLoadImages : function(callback){
        this.loadingSmiley()
        this.t0=Date.now();
        if (Experiment.user.sessionID==4){
          jsPsych.pluginAPI.preloadImages(this.imgPaths(),function(){Experiment.img.imagesLoaded()});
        }else{
          jsPsych.pluginAPI.preloadImages(this.fractals.paths(),function(){Experiment.img.imagesLoaded()});
        };
      },
      imagesLoaded : function(t0){
        var t1 = (Date.now()-this.t0)/1000.0;
        this.loadedStatus = "loaded";
      },
      init : function(){
        this.loadedStatus = 'not loaded';
        this.preLoadImages();
      }
    };

    var Experiment = {
      user: User,
      img : Img,
      nTrials: parseInt(jsPsych.data.getURLVariable('nTrials')) || 280,
      displayStr : function(str){
        $('#fsDiv').html(str);
      },
      timeline : {
        contentDivStyle : 'position:absolute;width:800px;left:'+
                          +((screen.width-800)/2).toString()+'px;',
        buttonStyle : 'height:60px;width:90px;float:right;font-size:12px;font-weight:bold;margin-top:100px;',
        wrap : function(p,top){
          var divStyle = this.contentDivStyle;
          if (typeof top != 'undefined'){divStyle=divStyle+'top:'+top+'px;'};
          var divStart = "<div id='content' style='"+divStyle+"'>"
          if (typeof p == 'string'){
            var t = divStart+p+'</div>';
          }else{
            var t = [];
            for (i=0;i<p.length;i++){
              t.push(divStart+p[i]+'</div>');
            };
          };
          return t;
        },
        enter_fullscreen_block : function(){
          var html = this.wrap(instructions.welcome,(screen.height*.5)-300);
          var buttonStyle = this.buttonStyle;
          var b={
            type: 'fullscreen',
            html: html,
            buttonStyle : buttonStyle,
            buttontext: "Enter",
            visibility: true,
            on_fullscreen_abort: function(){
              jsPsych.finishTrial();
              jsPsych.endExperiment('The experiment was terminated due to fullscreen abort.');
            },
            on_fullscreen_fail: function(){
              jsPsych.finishTrial();
              jsPsych.endExperiment('Your browser doesn\'t provide the necessary functionality. We recommend \
              using an up-to-date version of Firefox or Chrome.');
            },
            on_visibility_abort:function(){
              jsPsych.finishTrial();
              jsPsych.endExperiment('The experiment was terminated due to lack of visibility of the window.');
            },
            on_visibility_fail:function(){
              jsPsych.finishTrial();
              jsPsych.endExperiment('Your browser doesn\'t provide the necessary functionality. We recommend \
              using an up-to-date version of Firefox or Chrome.');
            }
          };
          return b
        },
        exit_fullscreen_block : function(){
          var html = this.wrap(instructions.end_fullscreen,(screen.height*.5)-250);
          var buttonStyle = this.buttonStyle;
          var b = {
            type : 'fullscreen',
            exit : true,
            buttonStyle : buttonStyle,
            buttontext: "Save & Exit",
            html : html,
            on_finish : function(data){
              Experiment.user.sessionEnd = new Date().toString();
              Experiment.saveData();
            }
          };
          return b;
        },
        confirmation_block : function(){
          page = this.wrap(instructions.confirmation,100)
          b = {
            type : 'instructions',
            pages : [page],
            on_trial_start : function(){
              setTimeout(function(){$('#conf_code').html(Experiment.user.sessionCode)},200);
            }
          };
          return b;
        },
        anna_block : function(){

          var getColorindex = function(){
            var colorindex = [];
            if (Experiment.user.sessionID==1){
              orig = [0,0,0,0,0,0,0,0,0,0];
              colorindex = orig;
              for (i=0;i<6;i++){colorindex =  orig.concat(colorindex.map( function(x) {return(x + 1)})); }
            }
            var addNTrials = Experiment.user.sessionID == 1 ? 30 : 40;
            var tempindex = [];
            for (t=0;t<7;t++){
              for(j=0;j<addNTrials;j++){
                tempindex.push(t);
              };
            };
            colorindex = colorindex.concat(jsPsych.randomization.shuffle(tempindex))
            return colorindex;
          };

          var getExpItems = function(){
            var colorcode = Experiment.user.colorcode;
            var arrowcode = Experiment.user.arrowcode;
            var mefirst = Experiment.user.mefirst;
            var fractals = Experiment.img.fractals.items;
            var arrowswitch = [2,3,0,1];
            var mefirstswitch = [1,0,3,2];
            // var values =  [[70,60,60,80],[70,30,40,80],[60,50,40,80],[80,30,60,60],[50,50,40,70],[70,30,50,50],[50,50,50,80]];
            var regularImgShuffled = Experiment.img.regular.shuffled();
            var items = jsPsych.randomization.shuffle(timeline);
            //make structure uniform
            items = items.map(function(i){
              if (typeof i.arrangement != 'object'){
                i.arrangement = [i.arrangement]
              };
              if (typeof i.combination != 'object'){
                i.combination = [i.combination]
              };
              return i
            });

            var regIdx = 0;
            items = items.map(function(i){
              //distribute images
              i.imgs = [];
              i.m = mefirst;
              i.c = [-1,-1];
              i.v = [-1,-1];
              i.a = [-1,-1];
              i.p = i.arrangement.length == 2 ? [i.p.slice(0,4),i.p.slice(4,8)] : [i.p.slice(0,4)];
              i.d = i.p;
              for(j=0;j<i.arrangement.length;j++){
                if(i.arrangement[j]==1){
                  i.imgs[j] = regularImgShuffled[regIdx];
                  regIdx++
                }else{
                  var valueversion = i.combination[j] - 1;
                  var colorversion = colorcode.indexOf(valueversion)
                  var arrowversion = arrowcode[colorversion]
                  i.v[j] = valueversion;
                  i.c[j] = colorversion;
                  i.a[j] = arrowversion;
                  i.imgs[j] = fractals[colorversion];
                  if (arrowversion == 1){
                    var vals = i.p[j]
                    i.p[j] = vals.map(function(val,j){return vals[arrowswitch[j]]})
                  };
                };
                if (mefirst==0){
                  var vals = i.d[j]
                  i.d[j] = vals.map(function(val,j){return vals[mefirstswitch[j]]})
                }
              };
              return i
            });
            return items;
          };

          var getTrainingItems = function(){
            var colorindex = getColorindex();
            var colorcode = Experiment.user.colorcode;
            var arrowcode = Experiment.user.arrowcode;
            var mefirst = Experiment.user.mefirst;
            var fractals = Experiment.img.fractals.items;
            var arrowswitch = [2,3,0,1];
            var mefirstswitch = [1,0,3,2];
            var values =  [[70,60,60,80],[70,30,40,80],[60,50,40,80],[80,30,60,60],[50,50,40,70],[70,30,50,50],[50,50,50,80]];

            var items = colorindex.map(function(i){
              var valueversion = colorcode[i]
              var arrowversion = arrowcode[i]
              if (arrowversion == 0){
                var vals = values[valueversion]
              }else{
                var vals = values[valueversion]
                vals = vals.map(function(val,j){return vals[arrowswitch[j]]})
              };
              dispVals = mefirst == 1 ? vals : vals.map(function(val,j){return vals[mefirstswitch[j]]})

              var n = {
                c : [i],
                v : [valueversion],
                a : [arrowversion],
                condition : 'T',
                arrangement : [2],
                combination : [valueversion+1],
                imgs : [fractals[i]],
                p : [vals],
                d : [dispVals],
                m : mefirst,
                isfoil  : 0
              }
              return n
            });

            return items.slice(0,Experiment.nTrials)
          };

          b = {
            type: 'anna',
            timeline : Experiment.user.sessionID == 4 ? getExpItems() : getTrainingItems()
          };
          return b;
        },
        init : function(){
          var timeline  =  [];
          timeline.push(this.enter_fullscreen_block());
          timeline.push(this.anna_block());
          timeline.push(this.exit_fullscreen_block());
          timeline.push(this.confirmation_block());
          return timeline;
        }
      },
      backgroundDiv : function(){
        var fsDiv = "<div id='fsDiv' style='background-color:rgb(140,140,140);text-algin:center;position:absolute;"+
                    "height:"+screen.height.toString()+"px;width:"+screen.width.toString()+"px;margin:0px;'></div>";
        $('body').html(fsDiv);
      },
      wrap : function(p){
        var divStr = '<div style="width:800px;margin-left:'+((screen.width-800)/2).toString()+
                      'px;">'+p+'</div>'
        return divStr
      },
      startJsPsych : function(){
        this.backgroundDiv();
        var timeline = this.timeline.init();
        jsPsych.init({
          display_element: $('#fsDiv'),
          timeline: timeline
        });
      },
      saveData : function(){
        // var json2csv = function(objArray){
        //     var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
        //     var str = '';
        //     var line = '';
        //     var quote = true;
        //     var header = true
        //
        //     if (header==true) {
        //         var head = array[0];
        //         if ($("#quote").is(':checked')) {
        //             for (var index in array[0]) {
        //                 var value = index + "";
        //                 line += '"' + value.replace(/"/g, '""') + '",';
        //             }
        //         } else {
        //             for (var index in array[0]) {
        //                 line += index + ',';
        //             }
        //         }
        //
        //         line = line.slice(0, -1);
        //         str += line + '\r\n';
        //     }
        //
        //     for (var i = 0; i < array.length; i++) {
        //         var line = '';
        //
        //         if (quote==true) {
        //             for (var index in array[i]) {
        //                 var value = array[i][index] + "";
        //                 line += '"' + value.replace(/"/g, '""') + '",';
        //             }
        //         } else {
        //             for (var index in array[i]) {
        //                 line += array[i][index] + ',';
        //             }
        //         }
        //
        //         line = line.slice(0, -1);
        //         str += line + '\r\n';
        //     }
        //     return str;
        //
        // };
        //
        function getUserDataAsCSV(){
          var keys = Object.keys(Experiment.user)
          var header = '';
          var dataStr = ''
          var info = Experiment.user

          for (i=0;i<keys.length;i++){
            console.log(typeof info[keys[i]])
            var t = typeof info[keys[i]] == 'object' ? info[keys[i]].join('') : info[keys[i]];
            header= i>0 ? header+','+keys[i] : keys[i];
            dataStr= i>0 ? dataStr+','+t : t;
          }
          dataStr = header+'\n'+dataStr+'\n';
          console.log(dataStr)
          return dataStr
        }
        var csvStrings = [jsPsych.data.dataOfTypeAsCSV('anna'),getUserDataAsCSV()]
        $.ajax({
          type: 'post',
          cache: false,
          url: './store2.php',
          data: {subjectID: [Experiment.user.UID,Experiment.user.sessionID,Experiment.user.sessionCode].join('-'), folder: 'anna', csvStrings: csvStrings, dataAsJSON: [jsPsych.data.dataAsJSON(),JSON.stringify(Experiment.user)]}
        });
        console.log('Data saved.');
      },
      abort : function(str){
        this.displayStr(str);
        throw new Error('Experiment aborted.');
      },
      waitForImgsAndStartExperiment : function(){
        if(Experiment.img.loadedStatus == 'not loaded'){
          setTimeout(Experiment.waitForImgsAndStartExperiment,1000);
        }else{
          Experiment.startJsPsych()
        };
      },
      init : function(){
        this.user = this.user.init();
        this.img.init();
        this.waitForImgsAndStartExperiment();
      }
    };

    window.onload = function(){
      Experiment.init()
    };

    </script>
</html>
