<!doctype html>
<html>
    <head>
        <title>Timgroup: Experiment 1</title>
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
        <script src="./jsPsych-4.3/jquery.min.js"></script>
        <script src="./jsPsych-4.3/jspsych.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-instructions.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-html-input-ao.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-fullscreen.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-anna.js"></script>
        <script src="./timeline.js"></script>
        <script src="./guiInfo.js"></script>
        <script src="./userInfo.js"></script>
        <script src="./imgData.js"></script>
        <!-- <script> var ip = "<?php echo $_SERVER['REMOTE_ADDR']; ?>";</script> -->
        <link href="./jsPsych-4.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body>
    </body>
    <script>

    var User = {
      urlHasId : function(){
        if (Object.keys(jsPsych.data.fromURL()).indexOf('id') > -1){
          return true;
        }else{
          return false;
        };
      },
      urlId : function(){
        return jsPsych.data.fromURL('id')['id'];
      },
      checkId : function(){
        var userInfoIds = userInfo.map(function(i){return i['UID']});
        if (userInfoIds.indexOf(this.Id) > -1){
          return true;
        }else{
          return false;
        };
      },
      setId : function(){
        if (this.urlHasId()){
          this.Id = this.urlId();
        }else{
          this.Id = prompt('Bitte geben sie Ihren persoenlichen Code ein:')
        };
      },
      getUserInfo : function(){
        var tempId = this.Id
        var t = userInfo.filter(function(i){
          return i['UID'] == tempId})[0];
        t.colorcode = t.colorcode.split('').map(function(i){return parseInt(i)})
        t.arrowcode = t.arrowcode.split('').map(function(i){return parseInt(i)})
        return t
      },
      init : function(){
        this.setId()
        var idx = 1;
        while(!this.checkId()&&idx<3){
          var tempId = prompt('Der angegebene persoenliche Code ist nicht korrekt. Probieren Sie es noch einmal:');
          this.Id = tempId;
          idx= idx+1;
        };
        if (idx>=3){
          this.setUserStatus('error')
          Experiment.cancelExperiment('Sie haben 3 mal eine inkorrekte User Id angegeben. Bitte kontaktieren Sie Anna Dereky.');
        }else{
          userObject = this.getUserInfo();
          userObject.Status = 'ready';
          return userObject
        };
      },
      setUserStatus: function(stat){
        this.Status = stat;
      }
    };

    var Env = {
      screenW: screen.width,
      screenH : screen.height,
      centX : screen.width*0.5,
      centY : screen.height*0.5,
      centLX : screen.width*0.25,
      centRX : screen.width*0.75
    };

    var Img = {
      regular : {
        items : imgData.regular,
        shuffled : function(){
          return jsPsych.randomization.shuffle(this.items);
        },
        paths : function(){
          return this.items.map(function(i){
            return i['path'];
          });
        }
      },
      fractals : {
        items : imgData.fractals,
        paths : function(){
          return this.items.map(function(i){
            return i['path'];
          });
        }
      },
      imgPaths : function(){
        return imgPaths =  this.regular.paths().concat(this.fractals.paths());
      },
      preLoadImages : function(callback){
        Experiment.displayStr('Loading Images');
        var = allImgPaths;
        console.log(this.imgPaths)
        var t0=Date.now();
        jsPsych.preloadImages(allImgPaths,
          function(t0){Experiment.img.imagesLoaded(t0)},
          function(i){$('body').html(i.toString()+' Images loaded')});
      },
      imagesLoaded : function(t0){
        var t1 = (Date.now()-t0)/1000.0;
        this.loadedStatus = "loaded"
        Experiment.displayStr('Images Loaded after: '+t1.toString()+'s');
        throw new error('loaded')
      },
      init : function(callback){
        this.loadedStatus = 'not loaded'
        this.preLoadImages(callback);
      }
    };

    // arrangement : 1 = P, 2=T;
    // var values = [ [70,70,60,80,50,70,50],
    //                [60,30,50,30,50,30,50],
    //                [60,40,40,60,40,50,50],
    //                [80,80,80,60,70,50,80] ]

    var Experiment = {
      user: User,
      env: Env,
      img : Img,
      displayStr : function(str){
        $('body').html(str);
      },
      jsAnnaBlock:function(){

        var items = jsPsych.randomization.shuffle(timeline);

        // items  = items.splice(0,10)
        items = items.map(function(i){
          if (typeof i.arrangement != 'object'){
            i.arrangement = [i.arrangement]
          };
          if (typeof i.combination != 'object'){
            i.combination = [i.combination]
          };
          i.imgs = [];
          return i
        })

        var colorcode = this.user.colorcode;
        var regularImgShuffled = this.img.regular.shuffled()
        var fractals = this.img.fractals.items

        var regIdx = 0;
        for (i=0;i<items.length;i++){
          for (j=0;j<items[i].arrangement.length;j++){
            if(items[i].arrangement[j]==1||items[i].isfoil==1){
              items[i].imgs[j] = regularImgShuffled[regIdx]
              regIdx++
            }else{
              var v = items[i].combination[j] - 1;
              items[i].imgs[j] = fractals[colorcode.indexOf(v)]
            };
          };
        };

        t = {
          type:'anna',
          items : items,
          user : this.user,
          env : this.env
        };

        return t;
      },
      // startJsPsych : function(){
      //   console.log(this.img.loadedStatus)
      //   var fsDiv = "<div id='fsDiv' style='background-color:rgb(140,140,140);text-algin:center;position:absolute;height:"+this.env.screenH.toString()+"px;width:"+this.env.screenW.toString()+"px;'></div>";
      //   $('body').html(fsDiv)
      //   if(this.img.loadedStatus=='loaded'){
      //     console.log(this.img.loadedStatus)
      //     jsPsych.init({
      //       display_element: $('#fsDiv'),
      //       experiment_structure: [this.jsAnnaBlock()]
      //     });
      //   }else {
      //     setTimeout(this.startJsPsych(), 1000); // check again in a second
      //   };
      // },
      cancelExperiment : function(str){
        this.displayStr(str)
        throw new Error('Experiment aborted.');
      },
      init : function(){
        this.user = this.user.init();
        console.log(this.img);
        this.img.init();
        console.log(this.img);
        // this.startJsPsych();
      }
    };
    Experiment.init()

    </script>
</html>
