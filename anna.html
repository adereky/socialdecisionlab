<!doctype html>
<html>
    <head>
        <title>Timgroup: Experiment 1</title>
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
        <script src="./jsPsych-4.3/jquery.min.js"></script>
        <script src="./jsPsych-4.3/jspsych.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-instructions.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-html-input-ao.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-fullscreen.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-anna.js"></script>
        <script src="./timeline.js"></script>
        <script src="./guiInfo.js"></script>
        <script src="./userInfo.js"></script>
        <script src="./imgData.js"></script>
        <!-- <script> var ip = "<?php echo $_SERVER['REMOTE_ADDR']; ?>";</script> -->
        <link href="./jsPsych-4.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link href="./loadingSmiley.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body>
    </body>
    <script>

    var User = {
      urlHasInfo : function(){
        var mandKeys = ['UID','colorcode','arrowcode','mefirst','charity','responseID'];
        var urlData = jsPsych.data.fromURL();
        for (var i =0;i<mandKeys.length;i++){
          if (Object.keys(urlData).indexOf(mandKeys[i])<= -1){
            return false
          };
          return true
        };
      },
      getUserInfo : function(){
        var urlData = jsPsych.data.fromURL();
        var userData = {
          UID : urlData.UID,
          arrowcode : urlData.arrowcode.split('').map(function(i){return parseInt(i)}),
          colorcode : urlData.colorcode.split('').map(function(i){return parseInt(i)}),
          mefirst : parseInt(urlData['mefirst']),
          charity :  urlData.charity
        };
        return userData
      },
      init: function(){
        if (this.urlHasInfo()){
          return this.getUserInfo()
        }else{
          $('body').html('Diese Url ist ungueltig. Bitte kontaktieren Sie Anna Dereky.');
          Experiment.abort()
        };
      }
    };

    var Env = {
      screenW: screen.width,
      screenH : screen.height,
      centX : screen.width*0.5,
      centY : screen.height*0.5,
      centLX : screen.width*0.25,
      centRX : screen.width*0.75
    };

    var Img = {
      regular : {
        items : imgData.regular,
        shuffled : function(){
          return jsPsych.randomization.shuffle(this.items);
        },
        paths : function(){
          return this.items.map(function(i){
            return i['path'];
          });
        }
      },
      fractals : {
        items : imgData.fractals,
        paths : function(){
          return this.items.map(function(i){
            return i['path'];
          });
        }
      },
      imgPaths : function(){
        return imgPaths =  this.regular.paths().concat(this.fractals.paths());
      },
      loadingSmiley : function(){
        Experiment.backgroundDiv()
        var smileyDivs = '<div id="loadingSmiley" style="margin-top:'+((screen.height*0.5)-100).toString()+'px;"><center><p>Loading</p>\
          <div class="leftEye"></div><div class="rightEye"></div><div class="mouth"></div></center></div>';
        Experiment.displayStr(smileyDivs)
      },
      preLoadImages : function(callback){
        this.loadingSmiley()
        var allImgPaths = this.imgPaths();
        this.t0=Date.now();
        jsPsych.preloadImages(allImgPaths,
          function(){Experiment.img.imagesLoaded();
          // },function(i){$('body').html(parseInt(i/allImgPaths.length*100).toString()+' Images loaded');
        });
      },
      imagesLoaded : function(t0){
        var t1 = (Date.now()-this.t0)/1000.0;
        this.loadedStatus = "loaded";
      },
      init : function(){
        this.loadedStatus = 'not loaded';
        this.preLoadImages();
      }
    };

    // arrangement : 1 = P, 2=T;
    // var values = [ [70,70,60,80,50,70,50],
    //                [60,30,50,30,50,30,50],
    //                [60,40,40,60,40,50,50],
    //                [80,80,80,60,70,50,80] ]

    var Experiment = {
      user: User,
      env: Env,
      img : Img,
      nTrials: 10,
      displayStr : function(str){
        $('#fsDiv').html(str);
      },
      getItems:function(){
        var items = jsPsych.randomization.shuffle(timeline);
        items = items.map(function(i){
          if (typeof i.arrangement != 'object'){
            i.arrangement = [i.arrangement]
          };
          if (typeof i.combination != 'object'){
            i.combination = [i.combination]
          };
          i.imgs = [];
          return i
        });

        var colorcode = this.user.colorcode;
        var regularImgShuffled = this.img.regular.shuffled();
        var fractals = this.img.fractals.items;

        var regIdx = 0;
        for (i=0;i<items.length;i++){
          for (j=0;j<items[i].arrangement.length;j++){
            if(items[i].arrangement[j]==1||items[i].isfoil==1){
              items[i].imgs[j] = regularImgShuffled[regIdx];
              regIdx++
            }else{
              var v = items[i].combination[j] - 1;
              items[i].imgs[j] = fractals[colorcode.indexOf(v)];
            };
          };
        };
        return items.slice(0,this.nTrials)
      },
      jsAnnaChunk:function(){
        t = {
          type:'anna',
          items : this.annaItems,
          user : this.user,
          env : this.env,
          on_finish : function(data){
            if (Experiment.annaItems.length == jsPsych.data.getTrialsOfType('anna').length){
              Experiment.saveData();
            };
          }
        };
        return t;
      },
      backgroundDiv : function(){
        var fsDiv = "<div id='fsDiv' style='background-color:rgb(140,140,140);text-algin:center;position:absolute;\
                    height:"+this.env.screenH.toString()+"px;width:"+this.env.screenW.toString()+"px;'></div>";
        $('body').html(fsDiv);
      },
      startJsPsych : function(){
        this.backgroundDiv()
        jsPsych.init({
          display_element: $('#fsDiv'),
          experiment_structure: [this.jsAnnaChunk()]
        });
      },
      saveData : function(){
        var csvStrings = [jsPsych.data.dataOfTypeAsCSV('anna')]
        $.ajax({
          type: 'post',
          cache: false,
          url: './store2.php',
          data: {subjectID: Experiment.user.UID, folder: 'anna', csvStrings: csvStrings, dataAsJSON: jsPsych.data.dataAsJSON()}
        });
        console.log('Data saved.');
      },
      abort : function(str){
        this.displayStr(str);
        throw new Error('Experiment aborted.');
      },
      waitForImgs : function(){
        if(Experiment.img.loadedStatus == 'not loaded'){
          setTimeout(Experiment.waitForImgs,1000);
        }else{
          Experiment.startJsPsych()
        };
      },
      init : function(){
        this.user = this.user.init();
        this.img.init();
        this.annaItems = this.getItems()
        this.waitForImgs();
      }
    };

    Experiment.init()

    </script>
</html>
