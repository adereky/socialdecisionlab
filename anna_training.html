<!doctype html>
<html>
    <head>
        <title>Timgroup: Experiment 1</title>
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
        <script src="./jsPsych-4.3/jquery.min.js"></script>
        <script src="./jsPsych-4.3/jspsych.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-instructions.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-fullscreen.js"></script>
        <script src="./jsPsych-4.3/plugins/jspsych-anna-training.js"></script>
        <script src="./guiInfo.js"></script>
        <script src="./userInfo.js"></script>
        <script src="./imgData.js"></script>
        <!-- <script> var ip = "<?php echo $_SERVER['REMOTE_ADDR']; ?>";</script> -->
        <link href="./jsPsych-4.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link href="./loadingSmiley.css" rel="stylesheet" type="text/css"></link>
    </head>
    <script>

    var User = {
      urlHasInfo : function(){
        var mandKeys = ['i','c','a','m','ch','r','s'];
        var urlData = jsPsych.data.fromURL();
        for (var i =0;i<mandKeys.length;i++){
          if (Object.keys(urlData).indexOf(mandKeys[i])<= -1){
            return false
          };
          return true
        };
      },
      getUserInfo : function(){
        var urlData = jsPsych.data.fromURL();
        var charityMap = {
          1 : 'WWF',
          2 : 'Greenpeace',
          3 : 'Declaration of Bern',
          4 : 'Amnesty International',
          7 : 'Caritas',
          8 : 'Terres des Hommes',
          9 : 'Unicef',
          10 : 'Médecins sans Frontières'
        };
        var userData = {
          UID : urlData.i,
          arrowcode : urlData.a.split('').map(function(i){return parseInt(i)}),
          colorcode : urlData.c.split('').map(function(i){return parseInt(i)}),
          mefirst : parseInt(urlData.m),
          charity : isNaN(urlData.ch) ? urlData.ch : charityMap[parseInt(urlData.ch)] ,
          responseID : urlData.r,
          sessionID : parseInt(urlData.s)
        };
        return userData
      },
      init: function(){
        if (this.urlHasInfo()){
          return this.getUserInfo()
        }else{
          $('body').html('Diese Url ist ungueltig. Bitte kontaktieren Sie Anna Dereky.');
          Experiment.abort()
        };
      }
    };

    var Img = {
      // regular : {
      //   items : imgData.regular,
      //   shuffled : function(){
      //     return jsPsych.randomization.shuffle(this.items);
      //   },
      //   paths : function(){
      //     return this.items.map(function(i){
      //       return i['path'];
      //     });
      //   }
      // },
      fractals : {
        items : imgData.fractals,
        paths : function(){
          return this.items.map(function(i){
            return i['path'];
          });
        }
      },
      imgPaths : function(){
        return imgPaths =  this.fractals.paths();
      },
      loadingSmiley : function(){
        Experiment.backgroundDiv()
        var smileyDivs = '<div id="loadingSmiley" style="margin-top:'+((screen.height*0.5)-100).toString()+'px;"><center><p>Loading</p>\
          <div class="leftEye"></div><div class="rightEye"></div><div class="mouth"></div></center></div>';
        Experiment.displayStr(smileyDivs)
      },
      preLoadImages : function(callback){
        this.loadingSmiley()
        var allImgPaths = this.imgPaths();
        this.t0=Date.now();
        jsPsych.preloadImages(allImgPaths,
          function(){Experiment.img.imagesLoaded();
          // },function(i){$('body').html(parseInt(i/allImgPaths.length*100).toString()+' Images loaded');
        });
      },
      imagesLoaded : function(t0){
        var t1 = (Date.now()-this.t0)/1000.0;
        this.loadedStatus = "loaded";
      },
      init : function(){
        this.loadedStatus = 'not loaded';
        this.preLoadImages();
      }
    };

    var Experiment = {
      user: User,
      img : Img,
      nTrials: parseInt(jsPsych.data.fromURL()['nTrials']) || 280,
      displayStr : function(str){
        $('#fsDiv').html(str);
      },
      timeline : {
        enter_fullscreen_block : function(){
          var pages = '';
          b = {
            type : 'fullscreen',
            html : pages,
            visibility : true
          }
        },
        instructions_block : function(){
          pages = ['pages']
          b = {
            type : 'instructions',
            pages : pages
          };
          return b;
        },
        anna_block : function(){
          var getColorindex = function(){
            var colorindex = [];
            if (Experiment.user.sessionID==1){
              orig = [0,0,0,0,0,0,0,0,0,0];
              colorindex = orig;
              for (i=0;i<6;i++){colorindex =  orig.concat(colorindex.map( function(x) {return(x + 1)})); }
            }
            var addNTrials = Experiment.user.sessionID == 1 ? 30 : 40;
            var tempindex = [];
            for (t=0;t<7;t++){
              for(j=0;j<addNTrials;j++){
                tempindex.push(t);
              };
            };
            colorindex = colorindex.concat(jsPsych.randomization.shuffle(tempindex))
            return colorindex;
          };
          var getAnnaItems = function(){
            var colorindex = getColorindex();
            var colorcode = Experiment.user.colorcode;
            var arrowcode = Experiment.user.arrowcode;
            var mefirst = Experiment.user.mefirst;
            var fractals = Experiment.img.fractals.items;
            var arrowswitch = [2,3,0,1];
            var mefirstswitch = [1,0,3,2];
            var values =  [[70,60,60,80],[70,30,40,80],[60,50,40,80],[80,30,60,60],[50,50,40,70],[70,30,50,50],[50,50,50,80]];

            var items = colorindex.map(function(i){
              var valueversion = colorcode[i]
              var arrowversion = arrowcode[i]
              if (arrowversion == 0){
                var vals = values[valueversion]
              }else{
                var vals = values[valueversion]
                vals = vals.map(function(val,j){return vals[arrowswitch[j]]})
              };
              dispVals = mefirst == 1 ? vals : vals.map(function(val,j){return vals[mefirstswitch[j]]})

              var n = {
                c : i,
                v : valueversion,
                a : arrowversion,
                condition : 'T',
                arrangement : [2],
                combination : [i],
                img : [fractals[i]],
                p : vals,
                d : dispVals,
                m : mefirst,
                isfoil  : 0
              }
              return n
            })

            return items
          };
          b = {
            type: 'anna-training',
            items : getAnnaItems(),
          };
          return b;
        },
        init : function(){
          var timeline  =  [];
          // timeline.push(this.enter_fullscreen_block());
          // timeline.push(this.instructions_block());
          timeline.push(this.anna_block());
          return timeline;
        }
      },
      backgroundDiv : function(){
        var fsDiv = "<div id='fsDiv' style='background-color:rgb(140,140,140);text-algin:center;position:absolute;"+
                    "height:"+screen.height.toString()+"px;width:"+screen.width.toString()+"px;'></div>";
        $('body').html(fsDiv);
      },
      wrap : function(p){
        var divStr = '<div style="width:800px;text-align:center;margin-left:'+((screen.width-800)/2).toString()+
                      'px;">'+p+'</div>'
        return divStr
      },
      startJsPsych : function(){
        this.backgroundDiv();
        var timeline = this.timeline.init();

        jsPsych.init({
          display_element: $('#fsDiv'),
          experiment_structure: timeline
        });
      },
      saveData : function(){
        var csvStrings = [jsPsych.data.dataOfTypeAsCSV('anna')]
        $.ajax({
          type: 'post',
          cache: false,
          url: './store2.php',
          data: {subjectID: Experiment.user.UID, folder: 'anna', csvStrings: csvStrings, dataAsJSON: jsPsych.data.dataAsJSON()}
        });
        console.log('Data saved.');
      },
      abort : function(str){
        this.displayStr(str);
        throw new Error('Experiment aborted.');
      },
      waitForImgsAndStartExperiment : function(){
        if(Experiment.img.loadedStatus == 'not loaded'){
          setTimeout(Experiment.waitForImgs,1000);
        }else{
          Experiment.startJsPsych()
        };
      },
      init : function(){
        this.user = this.user.init();
        this.img.init();
        this.waitForImgsAndStartExperiment();
      }
    };

    Experiment.init()

    </script>
</html>
