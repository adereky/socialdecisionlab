<!doctype html>
<html>
    <head>
        <title>Timgroup: Experiment 1</title>
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
        <script src="./jquery.min.js"></script>
        <script src="./jspsych.js"></script>
        <script src="./plugins/jspsych-instructions.js"></script>
        <script src="./plugins/jspsych-fullscreen.js"></script>
        <script src="./plugins/jspsych-anna.js"></script>
        <script src="./timeline.js"></script>
        <script src="./guiInfo.js"></script>
        <script src="./userInfo.js"></script>
        <script src="./imgData.js"></script>
        <!-- <script> var ip = "<?php echo $_SERVER['REMOTE_ADDR']; ?>";</script> -->
        <link href="./css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link href="./loadingSmiley.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body>
    </body>
    <script>

    var User = {
      urlHasInfo : function(){
        var mandKeys = ['i','c','a','m','ch','r'];
        var urlData = jsPsych.data.urlVariables();
        for (var i =0;i<mandKeys.length;i++){
          if (Object.keys(urlData).indexOf(mandKeys[i])<= -1){
            return false
          };
          return true
        };
      },
      getUserInfo : function(){
        var urlData = jsPsych.data.urlVariables();
        var charityMap = {
          1 : 'WWF',
          2 : 'Greenpeace',
          3 : 'Declaration of Bern',
          4 : 'Amnesty International',
          7 : 'Caritas',
          8 : 'Terres des Hommes',
          9 : 'Unicef',
          10 : 'Médecins sans Frontières'
        };
        var userData = {
          UID : urlData.i,
          arrowcode : urlData.a.split('').map(function(i){return parseInt(i)}),
          colorcode : urlData.c.split('').map(function(i){return parseInt(i)}),
          mefirst : parseInt(urlData.m),
          charity : isNaN(urlData.ch) ? urlData.ch : charityMap[parseInt(urlData.ch)],
          responseID : urlData.r
        };
        return userData
      },
      init: function(){
        if (this.urlHasInfo()){
          return this.getUserInfo()
        }else{
          $('body').html('Diese Url ist ungueltig. Bitte kontaktieren Sie Anna Dereky.');
          Experiment.abort()
        };
      }
    };

    var Env = {
      screenW: screen.width,
      screenH : screen.height,
      centX : screen.width*0.5,
      centY : screen.height*0.5,
      centLX : screen.width*0.25,
      centRX : screen.width*0.75
    };

    var Img = {
      regular : {
        items : imgData.regular,
        shuffled : function(){
          return jsPsych.randomization.shuffle(this.items);
        },
        paths : function(){
          return this.items.map(function(i){
            return i['path'];
          });
        }
      },
      fractals : {
        items : imgData.fractals,
        paths : function(){
          return this.items.map(function(i){
            return i['path'];
          });
        }
      },
      imgPaths : function(){
        return imgPaths =  this.regular.paths().concat(this.fractals.paths());
      },
      loadingSmiley : function(){
        Experiment.backgroundDiv()
        var smileyDivs = '<div id="loadingSmiley" style="margin-top:'+((screen.height*0.5)-100).toString()+'px;"><center><p>Loading</p>\
          <div class="leftEye"></div><div class="rightEye"></div><div class="mouth"></div></center></div>';
        Experiment.displayStr(smileyDivs)
      },
      preLoadImages : function(callback){
        this.loadingSmiley()
        var allImgPaths = this.imgPaths();
        this.t0=Date.now();
        jsPsych.pluginAPI.preloadImages(allImgPaths,
          function(){Experiment.img.imagesLoaded();
          // },function(i){$('body').html(parseInt(i/allImgPaths.length*100).toString()+' Images loaded');
        });
      },
      imagesLoaded : function(t0){
        var t1 = (Date.now()-this.t0)/1000.0;
        this.loadedStatus = "loaded";
      },
      init : function(){
        this.loadedStatus = 'not loaded';
        this.preLoadImages();
      }
    };

    var Experiment = {
      user: User,
      env: Env,
      img : Img,
      nTrials: parseInt(jsPsych.data.getURLVariable('nTrials')) || timeline.length,
      displayStr : function(str){
        $('#fsDiv').html(str);
      },
      getAnnaItems:function(){

        var colorcode = Experiment.user.colorcode;
        var arrowcode = Experiment.user.arrowcode;
        var mefirst = Experiment.user.mefirst;
        var fractals = Experiment.img.fractals.items;
        var arrowswitch = [2,3,0,1];
        var mefirstswitch = [1,0,3,2];
        // var values =  [[70,60,60,80],[70,30,40,80],[60,50,40,80],[80,30,60,60],[50,50,40,70],[70,30,50,50],[50,50,50,80]];
        var regularImgShuffled = this.img.regular.shuffled();
        var fractals = this.img.fractals.items;
        var items = jsPsych.randomization.shuffle(timeline);
        //make structure uniform
        items = items.map(function(i){
          if (typeof i.arrangement != 'object'){
            i.arrangement = [i.arrangement]
          };
          if (typeof i.combination != 'object'){
            i.combination = [i.combination]
          };
          return i
        });

        var regIdx = 0;
        items = items.map(function(i){
          //distribute images
          i.imgs = [];
          i.m = mefirst;
          i.c = [-1,-1];
          i.v = [-1,-1];
          i.a = [-1,-1];
          i.p = i.arrangement.length == 2 ? [i.p.slice(0,4),i.p.slice(4,8)] : [i.p.slice(0,4)];
          i.d = i.p;
          for(j=0;j<i.arrangement.length;j++){
            if(i.arrangement[j]==1){
              i.imgs[j] = regularImgShuffled[regIdx];
              regIdx++
            }else{
              var valueversion = i.combination[j] - 1;
              var colorversion = colorcode.indexOf(valueversion)
              var arrowversion = arrowcode[colorversion]
              i.v[j] = valueversion;
              i.c[j] = colorversion;
              i.a[j] = arrowversion;
              i.imgs[j] = fractals[colorversion];
              if (arrowversion == 1){
                var vals = i.p[j]
                i.p[j] = vals.map(function(val,j){return vals[arrowswitch[j]]})
              };
            };
            if (mefirst==0){
              var vals = i.d[j]
              i.d[j] = vals.map(function(val,j){return vals[mefirstswitch[j]]})
            }
          };
          return i
        });


        return items.slice(0,this.nTrials)
      },
      anna_block : function(){
        t = {
          type: 'anna',
          timeline : this.getAnnaItems()
        };
        return t;
      },
      end_block : function(){
        var parStr = this.wrap('<p>This is the end. Thank You.</p>');
        var b = {
          type : 'instructions',
          text : parStr
        };
        return b
      },
      backgroundDiv : function(){
        var fsDiv = "<div id='fsDiv' style='background-color:rgb(140,140,140);text-algin:center;position:absolute;"+
                    "height:"+this.env.screenH.toString()+"px;width:"+this.env.screenW.toString()+"px;margin:0px;'></div>";
        $('body').html(fsDiv);
      },
      wrap : function(p){
        var divStr = '<div style="width:800px;text-align:center;margin-left:'+((screen.width-800)/2).toString()+
                      'px;">'+p+'</div>'
        return divStr
      },
      startJsPsych : function(){
        this.backgroundDiv()
        var timeline  =  [];
        timeline.push(this.anna_block());
        // timeline.push(this.end_block());

        jsPsych.init({
          display_element: $('#fsDiv'),
          timeline: timeline
        });
      },
      saveData : function(){
        var csvStrings = [jsPsych.data.dataOfTypeAsCSV('anna')]
        $.ajax({
          type: 'post',
          cache: false,
          url: './store2.php',
          data: {subjectID: Experiment.user.UID, folder: 'anna', csvStrings: csvStrings, dataAsJSON: jsPsych.data.dataAsJSON()}
        });
        console.log('Data saved.');
      },
      abort : function(str){
        this.displayStr(str);
        throw new Error('Experiment aborted.');
      },
      waitForImgs : function(){
        if(Experiment.img.loadedStatus == 'not loaded'){
          setTimeout(Experiment.waitForImgs,1000);
        }else{
          Experiment.startJsPsych()
        };
      },
      init : function(){
        this.user = this.user.init();
        this.img.init();
        this.waitForImgs();
      }
    };

    Experiment.init()

    </script>
</html>
